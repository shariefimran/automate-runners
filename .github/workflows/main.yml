name: Distributed Load Testing with JMeter

on: [push]

jobs:
  setup-and-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        role: [master, slave] # Define roles: one master and one slave

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Download and Extract JMeter
        run: |
          wget https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-5.5.tgz -O jmeter.tgz
          tar -xzf jmeter.tgz
        shell: bash

      - name: Set JMeter Home and Path
        run: |
          export JMETER_HOME=$(pwd)/apache-jmeter-5.5
          echo "JMETER_HOME=$JMETER_HOME" >> $GITHUB_ENV
          echo "$JMETER_HOME/bin" >> $GITHUB_PATH
        shell: bash

      - name: Configure JMeter Properties
        run: |
          echo "server.rmi.ssl.disable=true" >> $JMETER_HOME/bin/user.properties
        shell: bash

      - name: Start JMeter Server (Slave)
        if: matrix.role == 'slave'
        run: |
          echo "Starting JMeter in server mode"
          nohup $JMETER_HOME/bin/jmeter-server > jmeter-server.log 2>&1 &
          sleep 10
          echo "Checking if JMeter Slave is running"
          pgrep -f jmeter-server || (echo "JMeter Slave failed to start" && exit 1)
          echo "JMeter Slave started successfully"
        shell: bash

      - name: Wait for Slave to Start
        if: matrix.role == 'master'
        run: |
          echo "Waiting for JMeter Slave to start"
          sleep 60
          echo "Checking if JMeter Slave is running"
          netstat -an | grep 1099 || (echo "JMeter Slave is not listening on port 1099" && exit 1)
          echo "JMeter Slave is listening on port 1099"
        shell: bash

      - name: Configure JMeter Master
        if: matrix.role == 'master'
        run: |
          echo "Configuring JMeter Master"
          echo "remote_hosts=127.0.0.1" >> $JMETER_HOME/bin/user.properties
        shell: bash

      - name: Run JMeter Test (Master)
        if: matrix.role == 'master'
        run: |
          echo "Running JMeter Test"
          $JMETER_HOME/bin/jmeter -n -t Demo.jmx -R127.0.0.1 -l test-results.jtl
          cat test-results.jtl
        shell: bash
